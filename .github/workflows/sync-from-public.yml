name: Sync Public → Private

on:
  repository_dispatch:
    types: [sync_public_to_private]  # Triggered by public repo webhook
  workflow_dispatch:                 # Allows manual trigger

permissions:
  contents: write 
  workflows: write
  
jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout default branch (main) to detect workflow
      - name: Checkout private repo default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history
          ref: main

      # 2️⃣ Set Git identity for any commits
      - name: Set up Git identity
        run: |
          git config user.name "public-repo-sync-bot"
          git config user.email "actions@github.com"

      # 3️⃣ Fetch target branch `current` and switch to it
      - name: Checkout target branch
        run: |
          git fetch origin current
          git checkout -B current origin/current

      # 4️⃣ Add public repo remote (read-only)
      - name: Add public repo remote
        run: |
          git remote add public https://github.com/smarvin/gl-copy-site.git || echo "Remote already exists"
          git fetch public mirror

      # 5️⃣ Debug: show remotes
      - name: Debug remotes
        run: git remote -v

      # 6️⃣ Merge public/mirror → current (squash merge, exclude workflows)
      - name: Merge public mirror into current
        run: |
          # Check if there are differences
          if git diff --quiet current public/mirror -- . ':!.github/workflows' 2>/dev/null; then
            echo "✅ No changes to merge (excluding workflows)"
            exit 0
          fi
          
          echo "Performing squash merge..."
          
          # Squash merge - stages changes without commit or history reference
          git merge --squash public/mirror --allow-unrelated-histories || {
            echo "⚠️ Conflicts detected, keeping private repo's version..."
            git checkout --ours .
            git add -A
          }
          
          # Remove any staged workflow file changes
          git reset HEAD -- .github/workflows/ 2>/dev/null || true
          git checkout -- .github/workflows/ 2>/dev/null || true
          
          # Check if there's anything left to commit
          if git diff --cached --quiet; then
            echo "ℹ️ No non-workflow changes to commit"
            exit 0
          fi
          
          # Commit the squashed changes (without workflow files)
          git commit -m "Sync from public mirror"
          echo "✅ Squash merge committed (workflows excluded)"

      # 7️⃣ Show last commits after merge
      - name: Show last commits
        run: git log -5 --oneline

      # 8️⃣ Push changes to private repo (current branch)
      - name: Push merged changes to private repo
        run: |
          if git diff --quiet origin/current 2>/dev/null; then
            echo "ℹ️ No changes to push"
          else
            git push origin current
            echo "✅ Changes pushed to private repo"
          fi

      # 9️⃣ Final confirmation
      - name: Sync complete
        run: echo "✅ Public → Private sync finished successfully"
