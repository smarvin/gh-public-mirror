name: Sync Public → Private

on:
  repository_dispatch:
    types: [sync_public_to_private]  # Triggered by public repo webhook
  workflow_dispatch:                 # Allows manual trigger

permissions:
  contents: write  # Needed to push changes to the private repo

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout default branch (main) to detect workflow
      - name: Checkout private repo default branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history
          ref: main

      # 2️⃣ Set Git identity for any commits
      - name: Set up Git identity
        run: |
          git config user.name "public-repo-sync-bot"
          git config user.email "actions@github.com"

      # 3️⃣ Fetch target branch `current` and switch to it
      - name: Checkout target branch
        run: |
          git fetch origin current
          git checkout -B current origin/current

      # 4️⃣ Add public repo remote (read-only)
      - name: Add public repo remote
        run: |
          git remote add public https://github.com/smarvin/gl-copy-site.git || echo "Remote already exists"
          git fetch public mirror

      # 5️⃣ Debug: show remotes
      - name: Debug remotes
        run: git remote -v

      # 6️⃣ Merge public/mirror → current (private repo wins conflicts, exclude workflows)
      - name: Merge public mirror into current
        run: |
          if git diff --quiet current public/mirror 2>/dev/null; then
            echo "✅ No changes to merge"
            exit 0
          fi
          
          if git merge --ff-only public/mirror 2>/dev/null; then
            echo "✅ Fast-forward merge succeeded"
            
            # Restore private workflows after fast-forward
            git checkout origin/current -- .github/workflows/ 2>/dev/null || true
            if ! git diff --quiet; then
              git add -A
              git commit -m "Restore private repo workflows"
            fi
          else
            echo "Attempting merge with --no-commit..."
            
            # Merge but don't commit yet
            git merge public/mirror --allow-unrelated-histories --no-commit --no-edit || {
              echo "⚠️ Conflicts detected, keeping private repo's version..."
              git checkout --ours .
            }
            
            # Restore private repo's workflow files BEFORE committing
            git checkout origin/current -- .github/workflows/ 2>/dev/null || true
            
            # Now commit the merge (without the workflow changes)
            git add -A
            git commit -m "Merge public mirror into current"
            echo "✅ Merge committed (private workflows preserved)"
          fi

      # 7️⃣ Show last commits after merge
      - name: Show last commits
        run: git log -5 --oneline

      # 8️⃣ Push changes to private repo (current branch)
      - name: Push merged changes to private repo
        run: |
          if git diff --quiet origin/current 2>/dev/null; then
            echo "ℹ️ No changes to push"
          else
            git push origin current
            echo "✅ Changes pushed to private repo"
          fi

      # 9️⃣ Final confirmation
      - name: Sync complete
        run: echo "✅ Public → Private sync finished successfully"
