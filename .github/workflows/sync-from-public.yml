name: Sync Public → Private

on:
  repository_dispatch:
    types: [sync_public_to_private]
  workflow_dispatch:

permissions:
  contents: write
  workflows: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout private repo (current branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: current

      - name: Set up Git identity
        run: |
          git config user.name "public-repo-sync-bot"
          git config user.email "actions@github.com"

      - name: Add public repo remote
        run: |
          git remote add public https://github.com/smarvin/gl-copy-site.git || echo "Remote already exists"
          git fetch public mirror

      - name: Debug remotes
        run: git remote -v

      # 6️⃣ One-time history alignment (runs once, then self-disables)
      - name: One-time history alignment
        run: |
          set -euo pipefail
      
          git checkout current
          git fetch public mirror
      
          # Skip if already aligned
          if [ -f .github/.history-aligned ]; then
            echo "History already aligned — skipping"
            exit 0
          fi
      
          # Skip if histories already related
          if git merge-base --is-ancestor public/mirror current 2>/dev/null || \
             git merge-base --is-ancestor current public/mirror 2>/dev/null; then
            echo "Histories already related — skipping"
            exit 0
          fi
      
          echo "Unrelated histories detected — aligning once"
      
          git reset --hard public/mirror
      
          mkdir -p .github
          echo "History aligned on $(date -u)" > .github/.history-aligned
          git add .github/.history-aligned
          git commit -m "Align history with public mirror (one-time)"
      
          git push origin current --force-with-lease

      # 6️⃣ Merge public/mirror → current safely
      # - name: Merge public mirror into current
      #  run: |
          # Try a fast-forward merge first
      #    if git merge --ff-only public/mirror; then
      #      echo "Fast-forward merge succeeded"
      #    else
            # Fallback to normal merge if needed
      #      git merge public/mirror --allow-unrelated-histories -m "Merge public mirror into current" || echo "No changes or merge conflict"
      #    fi

          echo "Unrelated histories detected — aligning once"

          git reset --hard public/mirror

          mkdir -p .github
          echo "History aligned on $(date -u)" > .github/.history-aligned
          git add .github/.history-aligned
          git commit -m "Align history with public mirror (one-time)"

          git push origin current --force-with-lease

      - name: Show last commits
        run: git log -5 --oneline

      - name: Sync complete
        run: echo "Public → Private sync finished successfully"
