name: Sync Private ‚Üí Public

on:
  repository_dispatch:
    types: [sync_public_to_private]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout private repo (current branch)
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          ref: current
          fetch-depth: 0
          token: ${{ secrets.SYNC_PAT }}

      # 2Ô∏è‚É£ Set Git identity
      - name: Set up Git identity
        run: |
          git config user.name "public-repo-sync-bot"
          git config user.email "actions@github.com"

      # 3Ô∏è‚É£ Clone public repo mirror branch to temp folder
      - name: Clone public repo (mirror branch)
        run: |
          git clone \
            --branch mirror \
            --single-branch \
            https://github.com/smarvin/gl-copy-site.git \
            /tmp/public-mirror

      # 4Ô∏è‚É£ Sync public ‚Üí private (exclude workflows and .git)
      - name: Sync files (exclude workflows and .git)
        run: |
          echo "üîÑ Syncing public ‚Üí private (excluding workflows and .git)..."
          rsync -av \
            --exclude='.github/workflows/' \
            --exclude='.git/' \
            /tmp/public-mirror/ \
            ./
          echo "‚úÖ rsync completed."

      # 5Ô∏è‚É£ Commit changes if any
      - name: Commit synced content
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "‚ú® No changes to commit."
          else
            git add -A
            # Don't add workflows even if rsync missed them
            git reset HEAD -- .github/workflows/ 2>/dev/null || true
            if git diff --cached --quiet; then
              echo "‚ú® No non-workflow changes to commit."
            else
              git commit -m "Sync from public mirror ‚Üí private current"
              echo "‚úÖ Changes committed."
            fi
          fi

      # 6Ô∏è‚É£ Push to private repo
      - name: Push to private repo
        run: |
          if git diff --quiet origin/current; then
            echo "‚ÑπÔ∏è No changes to push."
          else
            git push origin current
            echo "‚úÖ Pushed to private repo."
          fi

      # 7Ô∏è‚É£ Done
      - name: Sync complete
        run: echo "‚úÖ Public ‚Üí Private sync finished successfully"
